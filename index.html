<!DOCTYPE html>
<html>
  <head>
    <title>Geral colando</title>
    <style type="text/css">
      body {
        font-family: sans-serif;
        margin: 0;
        line-height: 1;
      }
      .container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: auto 1fr;
        gap: 8px;
        height: 100svh;
        padding: 8px;
        box-sizing: border-box;
      }
      h2 {
        margin: 0;
      }
      textarea {
        font-family: inherit;
        padding: 4px 8px;
        box-sizing: border-box;
        border: 1px solid black;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div>
        <h2>Trombone</h2>
        <label>
          <input type="radio" name="trombone-accidental" value="sharp" /> #
        </label>
        <label>
          <input type="radio" name="trombone-accidental" value="flat" checked />
          ♭
        </label>
      </div>
      <div>
        <h2>Trompete (Do)</h2>
        <label>
          <input type="radio" name="trumpet-accidental" value="sharp" checked />
          #
        </label>
        <label>
          <input type="radio" name="trumpet-accidental" value="flat" /> ♭
        </label>
      </div>
      <div>
        <h2>Sax (Mi♭)</h2>
        <label>
          <input type="radio" name="sax-accidental" value="sharp" checked /> #
        </label>
        <label>
          <input type="radio" name="sax-accidental" value="flat" /> ♭
        </label>
      </div>
      <textarea id="trombone"></textarea>
      <textarea id="trumpet"></textarea>
      <textarea id="sax"></textarea>
    </div>

    <script>
      const tromboneAccidental = "flat";
      const trumpetAccidental = "sharp";
      const saxAccidental = "sharp";

      const inputMap = {
        // starting on 15 means the note C2 saving space for future low octaves
        15: ["do"],
        16: ["do#", "reb", "re♭"],
        17: ["re"],
        18: ["re#", "mib", "mi♭"],
        19: ["mi"],
        20: ["fa"],
        21: ["fa#", "solb", "sol♭"],
        22: ["sol"],
        23: ["sol#", "lab", "la♭"],
        24: ["la"],
        25: ["la#", "sib", "si♭"],
        26: ["si"],
        27: ["Do"],
        28: ["Do#", "Reb", "Re♭"],
        29: ["Re"],
        30: ["Re#", "Mib", "Mi♭"],
        31: ["Mi"],
        32: ["Fa"],
        33: ["Fa#", "Solb", "Sol♭"],
        34: ["Sol"],
        35: ["Sol#", "Lab", "La♭"],
        36: ["La"],
        37: ["La#", "Sib", "Si♭"],
        38: ["Si"],
        39: ["DO"],
        40: ["DO#", "REb", "REB", "RE♭"],
        41: ["RE"],
        42: ["RE#", "MIb", "MIB", "MI♭"],
        43: ["MI"],
        44: ["FA"],
        45: ["FA#", "SOLb", "SOLB", "SOL♭"],
        46: ["SOL"],
        47: ["SOL#", "LAb", "LAB", "LA♭"],
        48: ["LA"],
        49: ["LA#", "SIb", "SIB", "SI♭"],
        50: ["SI"],
      };

      const inputDictionary = {};
      const outputDictionary = { flat: {}, sharp: {} };

      const tromboneOffset = 0;
      const trumpetOffset = -2;
      const saxOffset = +3;

      Object.entries(inputMap).forEach(([id, options]) => {
        const index = Number(id);

        // input
        options.forEach((option) => {
          inputDictionary[option] = index;
        });

        // output
        outputDictionary.sharp[index] = options[0];
        outputDictionary.flat[index] =
          options.find((o) => o.includes("b")) || options[0];
      });

      const getIndexedSheet = (value, offset = 0) =>
        value.replaceAll(/[a-zA-Z\#\♭]+/g, (match) => {
          return inputDictionary[match]
            ? inputDictionary[match] + offset
            : match;
        });

      const getOutput = (indexedSheet, dictionary, offset = 0) =>
        indexedSheet.replaceAll(/\d+/g, (match) => {
          const index = Number(match) - offset;
          return dictionary[index] ?? match;
        });

      const tromboneInput = document.querySelector("#trombone");
      const trumpetInput = document.querySelector("#trumpet");
      const saxInput = document.querySelector("#sax");

      tromboneInput.addEventListener("input", (e) => {
        const sheet = getIndexedSheet(e.currentTarget.value, tromboneOffset);
        trumpetInput.value = getOutput(
          sheet,
          outputDictionary[trumpetAccidental],
          trumpetOffset,
        );
        saxInput.value = getOutput(
          sheet,
          outputDictionary[saxAccidental],
          saxOffset,
        );
      });

      trumpetInput.addEventListener("input", (e) => {
        const sheet = getIndexedSheet(e.currentTarget.value, trumpetOffset);
        tromboneInput.value = getOutput(
          sheet,
          outputDictionary[tromboneAccidental],
          tromboneOffset,
        );
        saxInput.value = getOutput(
          sheet,
          outputDictionary[saxAccidental],
          saxOffset,
        );
      });

      saxInput.addEventListener("input", (e) => {
        const sheet = getIndexedSheet(e.currentTarget.value, saxOffset);
        tromboneInput.value = getOutput(
          sheet,
          outputDictionary[tromboneAccidental],
          tromboneOffset,
        );
        trumpetInput.value = getOutput(
          sheet,
          outputDictionary[trumpetAccidental],
          trumpetOffset,
        );
      });

      // dev mode
      //*
      tromboneInput.value =
        "fa sib Fa Sib FA SIb SIB \n\nla mi \n\nfa fa fa# fa# solb sol♭ mi.. \n\nLa♭__ La♭.. La";
      tromboneInput.dispatchEvent(new Event("input"));
      //*/
    </script>
  </body>
</html>
